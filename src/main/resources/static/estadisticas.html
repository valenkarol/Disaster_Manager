<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Estad√≠sticas - Sistema de Gesti√≥n de Desastres</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
            min-height: 100vh;
        }

        .navbar {
            background: linear-gradient(135deg, #8B5CF6 0%, #7C3AED 100%);
            padding: 15px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .nav-left {
            display: flex;
            align-items: center;
        }

        .nav-title {
            color: white;
            font-size: 1.3em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-menu {
            display: flex;
            gap: 15px;
            flex: 1;
            justify-content: center;
        }

        .nav-item {
            color: white;
            text-decoration: none;
            padding: 8px 16px;
            border-radius: 8px;
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .nav-item:hover {
            background: rgba(255,255,255,0.1);
        }

        .nav-item.active {
            background: white;
            color: #8B5CF6;
            font-weight: 600;
        }

        .search-box {
            position: relative;
        }

        .search-input {
            padding: 10px 15px 10px 40px;
            border-radius: 20px;
            border: none;
            width: 300px;
            background: white;
        }

        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
        }

        .btn-cerrar {
            background: #EF4444;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }

        .admin-badge {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
        }

        .container {
            padding: 40px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .kpi-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .kpi-card:hover {
            transform: translateY(-5px);
        }

        .kpi-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .kpi-value {
            font-size: 3em;
            font-weight: bold;
            color: #8B5CF6;
            margin-bottom: 10px;
        }

        .kpi-label {
            color: #666;
            font-size: 0.95em;
        }

        .chart-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chart-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
        }

        .chart-buttons {
            display: flex;
            gap: 10px;
        }

        .chart-btn {
            padding: 8px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .chart-btn.active {
            background: #8B5CF6;
            color: white;
        }

        .chart-btn:not(.active) {
            background: #E9D5FF;
            color: #8B5CF6;
        }

        .chart-wrapper {
            height: 350px;
            position: relative;
        }

        .options-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .section-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }

        .option-card {
            background: #F9FAFB;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .option-card:hover {
            border-color: #8B5CF6;
            transform: translateY(-3px);
        }

        .option-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }

        .option-label {
            color: #333;
            font-weight: 600;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .stat-title {
            font-weight: 600;
            color: #333;
        }

        .stat-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .badge-critical {
            background: #FEE2E2;
            color: #DC2626;
        }

        .badge-high {
            background: #FED7AA;
            color: #EA580C;
        }

        .badge-medium {
            background: #FEF3C7;
            color: #D97706;
        }

        .badge-low {
            background: #D1FAE5;
            color: #059669;
        }

        .stat-list {
            list-style: none;
        }

        .stat-list li {
            padding: 10px 0;
            border-bottom: 1px solid #F3F4F6;
            display: flex;
            justify-content: space-between;
        }

        .stat-list li:last-child {
            border-bottom: none;
        }

        .refresh-btn {
            background: #8B5CF6;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 30px;
            transition: all 0.3s;
        }

        .refresh-btn:hover {
            background: #7C3AED;
            transform: translateY(-2px);
        }

        @media (max-width: 768px) {
            .navbar {
                flex-direction: column;
                gap: 15px;
            }

            .nav-menu {
                flex-wrap: wrap;
                justify-content: center;
            }

            .container {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
<script>
    const rol = localStorage.getItem("rol");

    if (!rol) {
        window.location.href = "login.html";
    }

    // Solo ADMIN puede entrar a esta p√°gina
    if (rol !== "administrador") {
        alert("No tienes permiso para acceder a este panel");
        window.location.href = "index.html";
    }
</script>
<nav style="background: linear-gradient(90deg, #7c3aed 0%, #8b5cf6 100%); padding: 15px; display: flex; gap: 10px; justify-content: center; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); flex-wrap: wrap;">
    <style>
        .nav-button {
            background: transparent;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .nav-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .nav-button.active {
            background: white;
            color: #7c3aed;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .nav-button-logout {
            background: #dc2626;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .nav-button-logout:hover {
            background: #b91c1c;
            transform: translateY(-2px);
        }
    </style>

    <!-- Inicio -->
    <button class="nav-button active" onclick="window.location.href='index.html'">üè† Inicio</button>

    <!-- Admin panel -->
    <button class="nav-button" onclick="window.location.href='admin.html'">‚öôÔ∏è Administraci√≥n</button>

    <!-- Mapa -->
    <button class="nav-button" onclick="window.location.href='mapa.html'">üó∫Ô∏è Mapa</button>

    <!-- Rutas -->
    <button class="nav-button" onclick="window.location.href='rutas.html'">üìç Rutas</button>

    <!-- Estad√≠sticas -->
    <button class="nav-button" onclick="window.location.href='estadisticas.html'">üìä Estad√≠sticas</button>

    <!-- Logout -->
    <button class="nav-button-logout" onclick="cerrarSesion()">üö™ Cerrar Sesi√≥n</button>
</nav>

<script>
    function cerrarSesion() {
        if (confirm('¬øEst√° seguro que desea cerrar sesi√≥n?')) {
            alert('Sesi√≥n cerrada exitosamente');
            window.location.href = 'login.html';
        }
    }
</script>

<div class="container">
    <button class="refresh-btn" onclick="cargarDatos()">
        üîÑ Actualizar Datos
    </button>

    <div class="kpi-grid">
        <div class="kpi-card">
            <div class="kpi-icon">üì¶</div>
            <div class="kpi-value" id="totalRecursos">1386</div>
            <div class="kpi-label">Total Recursos Distribuidos</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon">üë•</div>
            <div class="kpi-value" id="totalEvacuados">3,456</div>
            <div class="kpi-label">Personas Evacuadas</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon">üö®</div>
            <div class="kpi-value" id="zonasActivas">12</div>
            <div class="kpi-label">Zonas Activas</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-icon">üë®‚Äç‚öïÔ∏è</div>
            <div class="kpi-value" id="equiposDesplegados">8</div>
            <div class="kpi-label">Equipos Desplegados</div>
        </div>
    </div>

    <div class="chart-section">
        <div class="chart-header">
            <div class="chart-title">Gr√°fica</div>
            <div class="chart-buttons">
                <button class="chart-btn active" onclick="cambiarGrafica('recursos')">Recursos</button>
                <button class="chart-btn" onclick="cambiarGrafica('evacuaciones')">Evacuaciones</button>
            </div>
        </div>
        <div class="chart-wrapper">
            <canvas id="mainChart"></canvas>
        </div>
    </div>

    <div class="options-section">
        <div class="section-title">
            üìç Opciones de Ubicaciones
        </div>
        <div class="options-grid">
            <div class="option-card" onclick="filtrarPorPrioridad('alta')">
                <div class="option-icon">üìç</div>
                <div class="option-label">Prioridad Alta</div>
            </div>
            <div class="option-card" onclick="filtrarPorPrioridad('media')">
                <div class="option-icon">üìç</div>
                <div class="option-label">Prioridad Media</div>
            </div>
            <div class="option-card" onclick="filtrarPorPrioridad('baja')">
                <div class="option-icon">üìç</div>
                <div class="option-label">Prioridad Baja</div>
            </div>
            <div class="option-card" onclick="verTodasUbicaciones()">
                <div class="option-icon">üó∫Ô∏è</div>
                <div class="option-label">Ubicaci√≥n General</div>
            </div>
        </div>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-title">‚ö†Ô∏è Zonas de Mayor Riesgo</span>
            </div>
            <ul class="stat-list" id="zonasRiesgo">
                <li><span>Cargando...</span></li>
            </ul>
        </div>
        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-title">üì¶ Recursos por Tipo</span>
            </div>
            <ul class="stat-list" id="recursosTipo">
                <li><span>Cargando...</span></li>
            </ul>
        </div>
        <div class="stat-card">
            <div class="stat-header">
                <span class="stat-title">üö® Evacuaciones Pendientes</span>
            </div>
            <ul class="stat-list" id="evacuacionesPendientes">
                <li><span>Cargando...</span></li>
            </ul>
        </div>
    </div>
</div>

<script>
    // üîß CONFIGURACI√ìN - Cambia el puerto aqu√≠ si es necesario
    const API_URL = 'http://localhost:8080';

    let mainChart = null;
    let datosGlobales = {};

    // Verificar conexi√≥n al cargar
    console.log('üåê Configuraci√≥n API:', API_URL);
    console.log('üì° Endpoints que se usar√°n:');
    console.log('  - GET', API_URL + '/zonas');
    console.log('  - GET', API_URL + '/recursos');
    console.log('  - GET', API_URL + '/evacuaciones');

    async function cargarDatos() {
        try {
            console.log('Intentando conectar con:', API_URL);

            // Intentar cargar zonas
            const zonasResponse = await fetch(`${API_URL}/zonas`);
            if (!zonasResponse.ok) throw new Error(`Error zonas: ${zonasResponse.status}`);
            const zonas = await zonasResponse.json();
            console.log('Zonas cargadas:', zonas);

            // Intentar cargar recursos
            const recursosResponse = await fetch(`${API_URL}/recursos`);
            if (!recursosResponse.ok) throw new Error(`Error recursos: ${recursosResponse.status}`);
            const recursos = await recursosResponse.json();
            console.log('Recursos cargados:', recursos);

            // Intentar cargar evacuaciones
            const evacuacionesResponse = await fetch(`${API_URL}/evacuaciones`);
            if (!evacuacionesResponse.ok) throw new Error(`Error evacuaciones: ${evacuacionesResponse.status}`);
            const evacuaciones = await evacuacionesResponse.json();
            console.log('Evacuaciones cargadas:', evacuaciones);

            datosGlobales = { zonas, recursos, evacuaciones };
            actualizarKPIs(zonas, recursos, evacuaciones);
            cambiarGrafica('recursos');
            actualizarEstadisticas(zonas, recursos, evacuaciones);

            console.log('‚úÖ Datos cargados exitosamente');
        } catch (error) {
            console.error('‚ùå Error detallado:', error);

            // Mostrar error m√°s espec√≠fico
            let mensaje = '‚ö†Ô∏è Error al conectar con el servidor\n\n';

            if (error.message.includes('Failed to fetch')) {
                mensaje += 'üî¥ El servidor no est√° respondiendo.\n\n';
                mensaje += 'Verifica que:\n';
                mensaje += '1. Tu backend Spring Boot est√© corriendo\n';
                mensaje += '2. Est√© en el puerto 8080\n';
                mensaje += '3. CORS est√© habilitado con @CrossOrigin\n\n';
                mensaje += `Intentando conectar a: ${API_URL}`;
            } else {
                mensaje += error.message;
            }

            alert(mensaje);

            // Cargar datos de ejemplo para testing
            cargarDatosEjemplo();
        }
    }

    function cargarDatosEjemplo() {
        console.log('‚ö†Ô∏è Cargando datos de ejemplo...');

        const zonas = {
            lista: [
                { id: '1', nombreZona: 'Zona Norte', nivelRiesgo: 9 },
                { id: '2', nombreZona: 'Zona Sur', nivelRiesgo: 7 },
                { id: '3', nombreZona: 'Zona Este', nivelRiesgo: 5 },
                { id: '4', nombreZona: 'Zona Oeste', nivelRiesgo: 8 },
                { id: '5', nombreZona: 'Zona Centro', nivelRiesgo: 6 }
            ]
        };

        const recursos = {
            lista: [
                { id: '1', nombre: 'Alimentos', cantidad: 450, tipo: 'ALIMENTOS', zonaAsignada: 'Zona Norte', equipoAsignado: 'Equipo A' },
                { id: '2', nombre: 'Medicinas', cantidad: 280, tipo: 'MEDICINAS', zonaAsignada: 'Zona Norte', equipoAsignado: 'Equipo B' },
                { id: '3', nombre: 'Agua', cantidad: 350, tipo: 'AGUA', zonaAsignada: 'Zona Sur', equipoAsignado: 'Equipo C' },
                { id: '4', nombre: 'Mantas', cantidad: 300, tipo: 'REFUGIO', zonaAsignada: 'Zona Sur', equipoAsignado: 'Equipo A' },
                { id: '5', nombre: 'Alimentos', cantidad: 250, tipo: 'ALIMENTOS', zonaAsignada: 'Zona Este', equipoAsignado: 'Equipo D' },
                { id: '6', nombre: 'Medicinas', cantidad: 400, tipo: 'MEDICINAS', zonaAsignada: 'Zona Oeste', equipoAsignado: 'Equipo B' },
                { id: '7', nombre: 'Agua', cantidad: 320, tipo: 'AGUA', zonaAsignada: 'Zona Oeste', equipoAsignado: 'Equipo E' },
                { id: '8', nombre: 'Alimentos', cantidad: 280, tipo: 'ALIMENTOS', zonaAsignada: 'Zona Centro', equipoAsignado: 'Equipo F' }
            ]
        };

        const evacuaciones = [
            { id: '1', zona: { nombreZona: 'Zona Norte', nivelRiesgo: 9 }, numeroAfectados: 1500, prioridad: 9, procesada: false },
            { id: '2', zona: { nombreZona: 'Zona Sur', nivelRiesgo: 7 }, numeroAfectados: 1200, prioridad: 7, procesada: true },
            { id: '3', zona: { nombreZona: 'Zona Este', nivelRiesgo: 5 }, numeroAfectados: 756, prioridad: 5, procesada: false },
            { id: '4', zona: { nombreZona: 'Zona Oeste', nivelRiesgo: 8 }, numeroAfectados: 1350, prioridad: 8, procesada: false },
            { id: '5', zona: { nombreZona: 'Zona Centro', nivelRiesgo: 6 }, numeroAfectados: 980, prioridad: 6, procesada: true }
        ];

        datosGlobales = { zonas, recursos, evacuaciones };
        actualizarKPIs(zonas, recursos, evacuaciones);
        cambiarGrafica('recursos');
        actualizarEstadisticas(zonas, recursos, evacuaciones);
    }

    function actualizarKPIs(zonas, recursos, evacuaciones) {
        const listaZonas = zonas.lista || [];
        const listaRecursos = recursos.lista || [];

        const totalRecursos = listaRecursos.reduce((sum, r) => sum + r.cantidad, 0);
        document.getElementById('totalRecursos').textContent = totalRecursos.toLocaleString();

        const totalEvacuados = evacuaciones.reduce((sum, e) => sum + e.numeroAfectados, 0);
        document.getElementById('totalEvacuados').textContent = totalEvacuados.toLocaleString();

        document.getElementById('zonasActivas').textContent = listaZonas.length;

        const equipos = new Set(listaRecursos.filter(r => r.equipoAsignado).map(r => r.equipoAsignado));
        document.getElementById('equiposDesplegados').textContent = equipos.size;
    }

    function cambiarGrafica(tipo) {
        // Actualizar botones activos
        document.querySelectorAll('.chart-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.textContent.toLowerCase().includes(tipo)) {
                btn.classList.add('active');
            }
        });

        const ctx = document.getElementById('mainChart');
        if (mainChart) {
            mainChart.destroy();
        }

        if (tipo === 'recursos') {
            crearGraficaRecursos();
        } else {
            crearGraficaEvacuaciones();
        }
    }

    function crearGraficaRecursos() {
        const ctx = document.getElementById('mainChart');
        const { zonas, recursos } = datosGlobales;
        const listaZonas = zonas.lista || [];
        const listaRecursos = recursos.lista || [];

        // Agrupar recursos por zona
        const recursosPorZona = {};
        const nivelRiesgoPorZona = {};

        listaZonas.forEach(zona => {
            recursosPorZona[zona.nombreZona] = 0;
            nivelRiesgoPorZona[zona.nombreZona] = zona.nivelRiesgo;
        });

        listaRecursos.forEach(recurso => {
            if (recurso.zonaAsignada && recursosPorZona.hasOwnProperty(recurso.zonaAsignada)) {
                recursosPorZona[recurso.zonaAsignada] += recurso.cantidad;
            }
        });

        const nombresZonas = Object.keys(recursosPorZona);
        const cantidadRecursos = Object.values(recursosPorZona);
        const nivelesRiesgo = nombresZonas.map(nombre => nivelRiesgoPorZona[nombre] * 10); // Escalar para visualizaci√≥n

        mainChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: nombresZonas,
                datasets: [
                    {
                        label: 'Recursos Asignados',
                        data: cantidadRecursos,
                        borderColor: '#8B5CF6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        tension: 0.4,
                        fill: true,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Nivel de Riesgo (x10)',
                        data: nivelesRiesgo,
                        borderColor: '#F59E0B',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        tension: 0.4,
                        fill: true,
                        yAxisID: 'y'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    if (context.dataset.label.includes('Riesgo')) {
                                        label += (context.parsed.y / 10).toFixed(1) + '/10';
                                    } else {
                                        label += context.parsed.y + ' recursos';
                                    }
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Cantidad'
                        }
                    }
                }
            }
        });
    }

    function crearGraficaEvacuaciones() {
        const ctx = document.getElementById('mainChart');
        const { zonas, evacuaciones } = datosGlobales;
        const listaZonas = zonas.lista || [];

        // Agrupar evacuaciones por zona
        const afectadosPorZona = {};
        const nivelRiesgoPorZona = {};

        listaZonas.forEach(zona => {
            afectadosPorZona[zona.nombreZona] = 0;
            nivelRiesgoPorZona[zona.nombreZona] = zona.nivelRiesgo;
        });

        evacuaciones.forEach(evacuacion => {
            const nombreZona = evacuacion.zona?.nombreZona;
            if (nombreZona && afectadosPorZona.hasOwnProperty(nombreZona)) {
                afectadosPorZona[nombreZona] += evacuacion.numeroAfectados;
            }
        });

        const nombresZonas = Object.keys(afectadosPorZona);
        const cantidadAfectados = Object.values(afectadosPorZona);
        const nivelesRiesgo = nombresZonas.map(nombre => nivelRiesgoPorZona[nombre] * 100); // Escalar para visualizaci√≥n

        mainChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: nombresZonas,
                datasets: [
                    {
                        label: 'Personas Afectadas',
                        data: cantidadAfectados,
                        borderColor: '#8B5CF6',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        tension: 0.4,
                        fill: true,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Nivel de Riesgo (x100)',
                        data: nivelesRiesgo,
                        borderColor: '#F59E0B',
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        tension: 0.4,
                        fill: true,
                        yAxisID: 'y'
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                if (context.parsed.y !== null) {
                                    if (context.dataset.label.includes('Riesgo')) {
                                        label += (context.parsed.y / 100).toFixed(1) + '/10';
                                    } else {
                                        label += context.parsed.y.toLocaleString() + ' personas';
                                    }
                                }
                                return label;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Cantidad'
                        }
                    }
                }
            }
        });
    }

    function actualizarEstadisticas(zonas, recursos, evacuaciones) {
        const listaZonas = zonas.lista || [];
        const listaRecursos = recursos.lista || [];

        // Zonas de mayor riesgo
        const zonasRiesgoHTML = listaZonas
            .sort((a, b) => b.nivelRiesgo - a.nivelRiesgo)
            .slice(0, 5)
            .map(z => {
                const badgeClass = z.nivelRiesgo >= 9 ? 'badge-critical' :
                    z.nivelRiesgo >= 7 ? 'badge-high' :
                        z.nivelRiesgo >= 4 ? 'badge-medium' : 'badge-low';
                return `<li>
                        <span>${z.nombreZona}</span>
                        <span class="stat-badge ${badgeClass}">${z.nivelRiesgo}/10</span>
                    </li>`;
            }).join('');
        document.getElementById('zonasRiesgo').innerHTML = zonasRiesgoHTML;

        // Recursos por tipo
        const recursosPorTipo = {};
        listaRecursos.forEach(r => {
            recursosPorTipo[r.tipo] = (recursosPorTipo[r.tipo] || 0) + r.cantidad;
        });
        const recursosHTML = Object.entries(recursosPorTipo)
            .slice(0, 5)
            .map(([tipo, cantidad]) =>
                `<li><span>${tipo}</span><span><strong>${cantidad}</strong></span></li>`
            ).join('');
        document.getElementById('recursosTipo').innerHTML = recursosHTML;

        // Evacuaciones pendientes
        const pendientes = evacuaciones
            .filter(e => !e.procesada)
            .sort((a, b) => b.prioridad - a.prioridad)
            .slice(0, 5);
        const evacuacionesHTML = pendientes
            .map(e => {
                const badgeClass = e.prioridad >= 8 ? 'badge-critical' : 'badge-high';
                return `<li>
                        <span>${e.zona?.nombreZona || 'N/A'}</span>
                        <span class="stat-badge ${badgeClass}">${e.numeroAfectados} afectados</span>
                    </li>`;
            }).join('');
        document.getElementById('evacuacionesPendientes').innerHTML = evacuacionesHTML || '<li>No hay evacuaciones pendientes</li>';
    }

    function filtrarPorPrioridad(nivel) {
        alert(`Filtrando por prioridad ${nivel}`);
    }

    function verTodasUbicaciones() {
        alert('Mostrando todas las ubicaciones');
    }

    // Cargar datos al inicio
    cargarDatos();
    setInterval(cargarDatos, 30000);
</script>
</body>
</html>